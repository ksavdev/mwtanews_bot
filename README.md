# MW:TA News Bot

Это Телеграм-бот, предназначенный для предоставления важнейших экономических новостей дня и недели. Бот отправляет уведомления в соответствии с настроенным часовым поясом пользователя, а также позволяет выбирать язык новостей и уровень важности отображаемой информации.

## Функциональные возможности

- **Ежедневные новости (/daily_news):**  
  Бот отправляет новости на текущий день с учётом настроенного часового пояса пользователя.

- **Недельные новости (/weekly_news):**  
  Отображается список всех важных новостей на текущую неделю.

- **Настройки пользователя:**
  - **Установка часового пояса (/set_utc, /utc_help):**  
    Пользователь может выбрать свой часовой пояс вручную или воспользоваться подсказкой, если не знает его.
  - **Настройка языка новостей (/set_lang):**  
    Позволяет выбрать язык новостей (Русский или English).
  - **Настройка уровня важности (/set_news_type):**  
    Пользователь может задать минимальный уровень важности новостей, которые будут присылаться ботом.

- **Подсказка и помощь (/help):**  
  Команда, которая выводит список доступных команд и краткое описание функционала бота.

- **Планирование отправки новостей:**  
  С использованием [node-cron](https://www.npmjs.com/package/node-cron) реализовано регулярное сканирование базы данных, определение локального времени пользователя и отправка уведомлений в заданное время.

- **Сбор новостей:**  
  Для получения новостей используется [puppeteer-extra](https://github.com/berstend/puppeteer-extra) с плагином stealth, а затем из HTML-страниц производится парсинг с помощью [cheerio](https://cheerio.js.org/) и [dayjs](https://day.js.org/).

## Структура проекта

```
mwtanews_bot/
├── src/
│   ├── core/
│   │   ├── bot.ts         // Инициализация и запуск бота, настройка middleware и команд
│   │   ├── config.ts      // Валидация и загрузка переменных окружения
│   │   ├── db.ts          // Конфигурация подключения к базе данных PostgreSQL
│   │   └── logger.ts      // Логирование (на основе pino)
│   ├── features/
│   │   ├── news/          // Функционал новостного модуля
│   │   │   ├── commands/
│   │   │   │   ├── dailyNews.ts   // Команда для ежедневных новостей
│   │   │   │   └── weeklyNews.ts  // Команда для новостей недели
│   │   │   ├── menus/           // Меню для выбора типа новостей и отображения информации
│   │   │   ├── scheduler/       // Планировщик отправки ежедневных новостей
│   │   │   └── services/        // Сервис для парсинга новостных событий (scraping)
│   │   └── user/          // Функционал управления пользователями
│   │       ├── commands/        // Команды для настройки (язык, часовой пояс, важность)
│   │       ├── conversations/   // Диалоги (например, помощь в определении часового пояса)
│   │       └── menus/           // Меню для выбора часового пояса
│   ├── shared/          // Общие константы и сообщения
│   └── index.ts         // Точка входа проекта
├── sql/                 // SQL-скрипты для создания базы данных
├── package.json         // Сценарии сборки, запуска и настройки проекта
├── tsconfig.json        // Конфигурация TypeScript
└── README.md            // Этот файл
```

## Установка и запуск

### Локальный запуск

1. **Клонируйте репозиторий и перейдите в папку проекта:**

   ```bash
   git clone <адрес репозитория>
   cd mwtanews_bot
   ```

2. **Установите зависимости:**

   ```bash
   npm ci
   ```

3. **Настройте переменные окружения:**  
   Создайте файл `.env` в корне проекта и укажите:
   
   ```properties
   TG_BOT_TOKEN=ВАШ_ТОКЕН_БОТА
   TE_TOKEN=ВАШ_TE_TOKEN
   DATABASE_URL=postgresql://botuser:devPassword42@localhost:15432/botdb
   LOG_LEVEL=debug
   DAILY_NEWS_HOUR=9
   DAILY_NEWS_MINUTE=0
   ```

4. **Запустите компиляцию TypeScript:**

   ```bash
   npm run build
   ```

5. **Запустите бота:**

   ```bash
   npm start
   ```

### Запуск через Docker

1. **Соберите и запустите контейнеры:**

   ```bash
   npm run docker
   ```

   Контейнеры будут запущены через `docker-compose.yml`. Проверьте, что все переменные окружения указаны корректно в файле `.env`.

## База данных

Проект использует PostgreSQL. Для инициализации базы данных выполните SQL-скрипт:

```bash
npm run migrate:init
```

Скрипт `001_create_user_settings.sql` создаст таблицу `user_settings` и необходимые триггеры.

## Используемые технологии

- **Node.js** – серверная платформа.
- **TypeScript** – язык программирования.
- **grammy** – фреймворк для разработки Телеграм-ботов.
- **postgresql** – база данных.
- **puppeteer-extra** с [Stealth Plugin](https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth) – для обхода ограничений при скрапинге.
- **cheerio** и **dayjs** – для парсинга HTML и обработки дат.
- **node-cron** – для реализации периодических задач.
- **Docker** – для контейнеризации приложения.

## Примечания

- Для автоматического форматирования и проверки кода используются ESLint и Prettier.
- Рекомендуется настроить окружение для разработки (например, VS Code) с поддержкой TypeScript, ESLint и Prettier для повышения качества кода.

